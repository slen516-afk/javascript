<script>
    var map = L.map('map').setView([25.0339145, 121.5412233], 13);


    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);


    // L.marker([25.0339145, 121.5412233]).addTo(map)
    //     .bindPopup('自訂訊息<br>可以放 HTML')
    //     .openPopup();


    let layerGroup = null;
    let arrLayers = [];


    document.querySelector('button#btn_request').addEventListener('click', function (event) {
        fetch('http://127.0.0.1:5000/cafes/taipei', {
            method: "GET"
        }).then(function (response) {
            return response.json();
        }).then(function (arr) {
            if (layerGroup != null) {
                layerGroup.clearLayers();
                map.removeLayer(layerGroup);


                layerGroup = null;
                arrLayers = [];
            }


            let tbody = document.querySelector('table > tbody');
            tbody.innerHTML = '';


            for (let o of arr) {
                let tr = document.createElement('tr');
                tr.innerHTML = `<td>${o['id']}</td>
                                    <td>${o['city']}</td>
                                    <td>${o['name']}</td>
                                    <td>${o['address']}</td>
                                    <td>${o['url']}</td>
                                    <td>${o['socket']}</td>`;


                tbody.appendChild(tr)


                let marker = L.marker([o['latitude'], o['longitude']]).bindPopup(`${o['name']}`);


                marker.addEventListener('click', function (event) {
                    console.log(o);
                });


                arrLayers.push(marker);
            }


            layerGroup = L.layerGroup(arrLayers);
            layerGroup.addTo(map);


        });
    });
</script>